<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡ÆÖ‡Æï‡Æ®‡Æø‡Æ∞‡Æ≤‡Øç</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Playfair+Display:wght@600;700&display=swap');

  :root {
    --bg: #f4f1eb;
    --card: #ffffff;
    --shadow: 0 2px 24px rgba(80,60,30,0.08);
    --shadow-hover: 0 6px 32px rgba(80,60,30,0.15);
    --green: #4a7c59;
    --green-light: #eaf4ec;
    --amber: #c88a3b;
    --amber-light: #faf3e6;
    --red: #c0504d;
    --red-light: #fae8e8;
    --blue: #3a6fa5;
    --blue-light: #eaf0f7;
    --text: #3a3530;
    --text-light: #8a7f73;
    --border: #e8e3db;
    --farm-badge: #6b8e6b;
    --organic-badge: #5a9a6e;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 0;
  }

  .header {
    background: linear-gradient(135deg, #3a3530 0%, #5a504a 100%);
    color: #fff;
    padding: 20px 24px 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 16px rgba(0,0,0,0.18);
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }
  .header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.55rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .header h1 span { color: var(--amber); }
  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .header-btn {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.85);
    padding: 6px 12px;
    border-radius: 18px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }
  .header-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
  .sync-status {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.6);
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .sync-status.synced { color: #4ade80; }

  .tabs {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    flex-shrink: 0;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 500;
    border: 1px solid rgba(255,255,255,0.2);
    background: transparent;
    color: rgba(255,255,255,0.7);
    cursor: pointer;
    transition: all 0.2s;
  }
  .tab.active, .tab:hover { background: rgba(255,255,255,0.15); color: #fff; border-color: rgba(255,255,255,0.4); }
  .tab.active { background: var(--amber); border-color: var(--amber); color: #fff; }

  .main { padding: 16px; max-width: 680px; margin: 0 auto; }

  .add-btn {
    width: 100%;
    padding: 14px;
    border: 2px dashed var(--border);
    border-radius: 14px;
    background: var(--card);
    color: var(--text-light);
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
    margin-bottom: 14px;
  }
  .add-btn:hover { border-color: var(--green); color: var(--green); background: var(--green-light); }
  .add-btn .plus { font-size: 1.3rem; }

  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(40,35,30,0.55);
    z-index: 200;
    justify-content: center;
    align-items: flex-end;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--card);
    width: 100%; max-width: 520px;
    border-radius: 22px 22px 0 0;
    padding: 20px 20px 28px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.25s cubic-bezier(.4,0,.2,1);
  }
  @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 18px; }
  .modal h2 { font-family: 'Playfair Display', serif; font-size: 1.2rem; margin-bottom: 16px; color: var(--text); }

  .form-row { margin-bottom: 12px; }
  .form-row label { display: block; font-size: 0.78rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-light); margin-bottom: 5px; }
  .form-row input, .form-row select, .form-row textarea {
    width: 100%;
    padding: 10px 13px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: inherit;
    font-size: 0.9rem;
    color: var(--text);
    background: #fdfcfb;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline: none; border-color: var(--green); }
  .form-row textarea { resize: vertical; min-height: 52px; }
  .form-row select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a7f73' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 34px; }

  .form-row-inline { display: flex; gap: 10px; }
  .form-row-inline .form-row { flex: 1; }

  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
  .toggle-label { font-size: 0.88rem; font-weight: 500; display: flex; align-items: center; gap: 8px; }
  .toggle-label .toggle-icon { font-size: 1.1rem; }
  .toggle {
    width: 46px; height: 26px;
    border-radius: 13px;
    background: var(--border);
    position: relative;
    cursor: pointer;
    transition: background 0.25s;
    border: none;
    -webkit-appearance: none;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: '';
    position: absolute;
    top: 2px; left: 2px;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    transition: left 0.25s;
  }
  .toggle.on::after { left: 22px; }

  .conditional { display: none; }
  .conditional.visible { display: block; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .btn-row { display: flex; gap: 10px; margin-top: 18px; }
  .btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-family: inherit; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.18s; }
  .btn-primary { background: var(--green); color: #fff; }
  .btn-primary:hover { background: #3d6b4d; }
  .btn-secondary { background: var(--bg); color: var(--text-light); }
  .btn-secondary:hover { background: var(--border); }

  .section-title {
    font-size: 0.73rem;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 600;
    color: var(--text-light);
    margin: 18px 0 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title .count { background: var(--border); padding: 1px 8px; border-radius: 10px; font-size: 0.7rem; }

  .task-card {
    background: var(--card);
    border-radius: 14px;
    padding: 14px 15px;
    margin-bottom: 10px;
    box-shadow: var(--shadow);
    transition: box-shadow 0.2s, opacity 0.3s;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }
  .task-card:hover { box-shadow: var(--shadow-hover); }
  .task-card.done { opacity: 0.52; }
  .task-card.done .task-title { text-decoration: line-through; color: var(--text-light); }

  .task-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
  }
  .task-card[data-cat="shopping"]::before { background: var(--blue); }
  .task-card[data-cat="farm"]::before      { background: var(--green); }
  .task-card[data-cat="todo"]::before      { background: var(--amber); }

  .task-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
  .task-left { flex: 1; min-width: 0; }
  .task-title { font-weight: 600; font-size: 0.92rem; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .task-desc { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }

  .task-check {
    width: 24px; height: 24px;
    border-radius: 7px;
    border: 2px solid var(--border);
    background: #fff;
    cursor: pointer;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.18s;
  }
  .task-check:hover { border-color: var(--green); }
  .task-check.checked { background: var(--green); border-color: var(--green); }
  .task-check.checked::after { content: '‚úì'; color: #fff; font-size: 0.85rem; font-weight: 700; }

  .badges { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 0.72rem; font-weight: 600;
    padding: 3px 9px;
    border-radius: 20px;
  }
  .badge-person { background: var(--blue-light); color: var(--blue); }
  .badge-organic { background: var(--green-light); color: var(--organic-badge); }
  .badge-farm { background: #eef5ee; color: var(--farm-badge); }
  .badge-location { background: #f0f4f8; color: #5a7a8f; }
  .badge-store { background: var(--amber-light); color: var(--amber); }
  .badge-date { background: #f0eae3; color: var(--text-light); }
  .badge-cat { background: #f2f0ec; color: var(--text-light); }

  .task-delete {
    position: absolute;
    top: 10px; right: 10px;
    background: none; border: none;
    color: var(--border);
    font-size: 1rem; cursor: pointer;
    padding: 2px 5px;
    border-radius: 5px;
    transition: color 0.18s;
    display: none;
  }
  .task-card:hover .task-delete { display: block; }
  .task-card:hover .task-delete:hover { color: var(--red); }

  .status-btn {
    font-size: 0.72rem;
    font-weight: 600;
    border: none;
    background: none;
    color: var(--text-light);
    cursor: pointer;
    padding: 2px 0;
    font-family: inherit;
    border-bottom: 1px dashed var(--border);
    margin-top: 4px;
    transition: color 0.18s;
  }
  .status-btn:hover { color: var(--blue); }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-light);
  }
  .empty-state .icon { font-size: 2.4rem; margin-bottom: 10px; }
  .empty-state p { font-size: 0.88rem; }

  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--text);
    color: #fff;
    padding: 10px 22px;
    border-radius: 24px;
    font-size: 0.82rem;
    font-weight: 500;
    z-index: 300;
    transition: transform 0.3s cubic-bezier(.4,0,.2,1);
    pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  @media (max-width: 520px) {
    .main { padding: 12px; }
    .modal { border-radius: 20px 20px 0 0; padding: 18px 16px 32px; }
    .header-actions { flex-direction: column; gap: 4px; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1>üè° <span>‡ÆÖ‡Æï‡Æ®‡Æø‡Æ∞‡Æ≤‡Øç</span> Aga-Niral</h1>
    <div class="header-actions">
      <button class="header-btn" id="archiveBtn">üì¶ Archive</button>
      <button class="header-btn" id="clearBtn">üóëÔ∏è Clear Done</button>
      <div class="sync-status synced" id="syncStatus">‚óè live</div>
    </div>
  </div>
  <div class="tabs" id="tabs">
    <button class="tab active" data-filter="all">All</button>
    <button class="tab" data-filter="pending">Pending</button>
    <button class="tab" data-filter="shopping">üõí Shopping</button>
    <button class="tab" data-filter="farm">üåø Farm</button>
    <button class="tab" data-filter="todo">üìù To-Do</button>
    <button class="tab" data-filter="done">‚úÖ Done</button>
    <button class="tab" data-filter="person:Velu">üë§ Velu</button>
    <button class="tab" data-filter="person:Selvi">üë§ Selvi</button>
    <button class="tab" data-filter="person:Devika">üë§ Devika</button>
    <button class="tab" data-filter="person:Krisshi">üë§ Krisshi</button>
  </div>
</div>

<div class="main">
  <button class="add-btn" id="openModal"><span class="plus">+</span> Add Task or Item</button>
  <div id="taskList"></div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modalTitle">New Task</h2>

    <div class="form-row">
      <label>What needs to be done?</label>
      <input type="text" id="taskName" placeholder="e.g. Buy almond milk" autocomplete="off"/>
    </div>

    <div class="form-row">
      <label>Category</label>
      <select id="taskCategory">
        <option value="todo">üìù To-Do</option>
        <option value="shopping">üõí Shopping</option>
        <option value="farm">üåø From the Farm</option>
      </select>
    </div>

    <div class="form-row conditional" id="locationField">
      <label>Location</label>
      <select id="taskLocation">
        <option value="">‚Äî Not specified ‚Äî</option>
        <option value="home">üè† Home</option>
        <option value="sapling">üöú Sapling Farms</option>
        <option value="other">üìç Other</option>
      </select>
    </div>

    <div class="form-row">
      <label>Assign to</label>
      <select id="taskPerson">
        <option value="">‚Äî Anyone ‚Äî</option>
      </select>
    </div>

    <div class="conditional" id="shoppingFields">
      <div class="form-row-inline">
        <div class="form-row">
          <label>Quantity</label>
          <input type="text" id="taskQtyShopping" placeholder="e.g. 2" autocomplete="off"/>
        </div>
        <div class="form-row">
          <label>Unit</label>
          <select id="taskUnit">
            <option value="pieces">Pieces</option>
            <option value="lb">lb</option>
            <option value="oz">oz</option>
            <option value="kg">kg</option>
            <option value="custom">Custom...</option>
          </select>
        </div>
      </div>
      <div class="form-row conditional" id="customUnitField">
        <label>Custom Unit</label>
        <input type="text" id="taskCustomUnit" placeholder="e.g. bunches, cans..." autocomplete="off"/>
      </div>
      <div class="form-row">
        <label>Where to buy</label>
        <input type="text" id="taskStore" placeholder="e.g. Whole Foods" autocomplete="off" list="storesList"/>
        <datalist id="storesList"></datalist>
      </div>
      <div class="toggle-row">
        <span class="toggle-label"><span class="toggle-icon">üå±</span> Organic</span>
        <button class="toggle" id="organicToggle" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="conditional" id="farmFields">
      <div class="form-row">
        <label>Quantity</label>
        <input type="text" id="taskQtyFarm" placeholder="e.g. 1 dozen" autocomplete="off"/>
      </div>
      <div class="form-row">
        <label>Notes (harvest info, location‚Ä¶)</label>
        <textarea id="farmNote" placeholder="e.g. Pick mature ones from south bed"></textarea>
      </div>
    </div>

    <div class="form-row">
      <label>Due by (optional)</label>
      <input type="date" id="taskDate"/>
    </div>

    <div class="form-row" id="descField">
      <label>Notes</label>
      <textarea id="taskDesc" placeholder="Any extra details‚Ä¶"></textarea>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" id="closeModal">Cancel</button>
      <button class="btn btn-primary" id="saveTask">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Firebase Configuration
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  databaseURL: "https://aga-niral-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tasksRef = db.ref('tasks');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const FAMILY_MEMBERS = ["Velu", "Selvi", "Devika", "Krisshi"];

let tasks  = [];
let filter = "all";
let editId = null;

const taskList    = document.getElementById("taskList");
const modalOver   = document.getElementById("modalOverlay");
const taskName    = document.getElementById("taskName");
const taskCat     = document.getElementById("taskCategory");
const taskPerson  = document.getElementById("taskPerson");
const taskLocation= document.getElementById("taskLocation");
const taskStore   = document.getElementById("taskStore");
const taskDate    = document.getElementById("taskDate");
const taskDesc    = document.getElementById("taskDesc");
const farmNote    = document.getElementById("farmNote");
const organicTog  = document.getElementById("organicToggle");
const taskUnit    = document.getElementById("taskUnit");
const taskCustomUnit = document.getElementById("taskCustomUnit");
const modalTitle  = document.getElementById("modalTitle");
const storesList  = document.getElementById("storesList");
const syncStatus  = document.getElementById("syncStatus");

FAMILY_MEMBERS.forEach(n => {
  const o = document.createElement("option");
  o.value = n; o.textContent = n;
  taskPerson.appendChild(o);
});

function updateConditional() {
  const cat = taskCat.value;
  document.getElementById("shoppingFields").classList.toggle("visible", cat === "shopping");
  document.getElementById("farmFields").classList.toggle("visible", cat === "farm");
  document.getElementById("locationField").classList.toggle("visible", cat === "todo" || cat === "farm");
  document.getElementById("descField").style.display = cat === "farm" ? "none" : "block";
  
  // Show custom unit field only when 'custom' is selected
  if (cat === "shopping") {
    const showCustom = taskUnit.value === "custom";
    document.getElementById("customUnitField").classList.toggle("visible", showCustom);
  }
}
taskCat.addEventListener("change", updateConditional);
taskUnit.addEventListener("change", updateConditional);

document.getElementById("openModal").addEventListener("click", () => openModal(null));
document.getElementById("closeModal").addEventListener("click", closeModal);
modalOver.addEventListener("click", e => { if (e.target === modalOver) closeModal(); });

function openModal(task) {
  editId = task ? task.id : null;
  modalTitle.textContent = task ? "Edit Task" : "New Task";

  taskName.value   = task ? task.name : "";
  taskCat.value    = task ? task.category : "todo";
  taskPerson.value = task ? (task.person || "") : "";
  taskLocation.value = task ? (task.location || "") : "";
  taskStore.value  = task ? (task.store || "") : "";
  taskDate.value   = task ? (task.date || "") : "";
  taskDesc.value   = task ? (task.desc || "") : "";
  farmNote.value   = task ? (task.farmNote || "") : "";
  organicTog.classList.toggle("on", task ? !!task.organic : false);
  document.getElementById("taskQtyShopping").value = task ? (task.qty || "") : "";
  document.getElementById("taskQtyFarm").value     = task ? (task.qty || "") : "";
  taskUnit.value = task ? (task.unit || "pieces") : "pieces";
  taskCustomUnit.value = task ? (task.customUnit || "") : "";

  updateConditional();
  modalOver.classList.add("open");
  setTimeout(() => taskName.focus(), 120);
}

function closeModal() {
  modalOver.classList.remove("open");
  editId = null;
}

document.getElementById("saveTask").addEventListener("click", async () => {
  const name = taskName.value.trim();
  if (!name) { taskName.style.borderColor = "var(--red)"; taskName.focus(); return; }
  taskName.style.borderColor = "";

  const cat     = taskCat.value;
  const qty     = cat === "shopping" ? document.getElementById("taskQtyShopping").value.trim() : (cat === "farm" ? document.getElementById("taskQtyFarm").value.trim() : "");
  const unit    = cat === "shopping" ? taskUnit.value : "";
  const customUnit = (cat === "shopping" && unit === "custom") ? taskCustomUnit.value.trim() : "";
  
  const payload = {
    id       : editId || Date.now().toString(36) + Math.random().toString(36).slice(2),
    name,
    category : cat,
    person   : taskPerson.value,
    location : (cat === "todo" || cat === "farm") ? taskLocation.value : "",
    store    : cat === "shopping" ? taskStore.value.trim() : "",
    qty      : qty,
    unit     : unit,
    customUnit: customUnit,
    organic  : cat === "shopping" ? organicTog.classList.contains("on") : false,
    date     : taskDate.value,
    desc     : cat !== "farm" ? taskDesc.value.trim() : "",
    farmNote : cat === "farm" ? farmNote.value.trim() : "",
    done     : editId ? (tasks.find(t => t.id === editId) || {}).done || false : false,
    createdAt: editId ? (tasks.find(t => t.id === editId) || {}).createdAt || Date.now() : Date.now()
  };

  try {
    await tasksRef.child(payload.id).set(payload);
    closeModal();
    showToast(editId ? "Task updated" : "Task added ‚úì");
  } catch (err) {
    console.error("Save error:", err);
    showToast("‚ö†Ô∏è Save failed");
  }
});

// Real-time listener
tasksRef.on('value', (snapshot) => {
  tasks = [];
  snapshot.forEach((child) => {
    tasks.push(child.val());
  });
  render();
});

document.getElementById("tabs").addEventListener("click", e => {
  const tab = e.target.closest(".tab");
  if (!tab) return;
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  tab.classList.add("active");
  filter = tab.dataset.filter;
  render();
});

function render() {
  const stores = [...new Set(tasks.map(t => t.store).filter(Boolean))];
  storesList.innerHTML = stores.map(s => `<option value="${s}">`).join("");

  let visible = tasks;
  if (filter === "pending")  visible = tasks.filter(t => !t.done);
  if (filter === "done")     visible = tasks.filter(t => t.done);
  if (filter === "shopping") visible = tasks.filter(t => t.category === "shopping" && !t.done);
  if (filter === "farm")     visible = tasks.filter(t => t.category === "farm" && !t.done);
  if (filter === "todo")     visible = tasks.filter(t => t.category === "todo" && !t.done);
  if (filter.startsWith("person:")) {
    const person = filter.split(":")[1];
    visible = tasks.filter(t => t.person === person);
  }

  visible.sort((a, b) => {
    if (a.done !== b.done) return a.done ? 1 : -1;
    if (a.date && b.date) return a.date.localeCompare(b.date);
    return b.createdAt - a.createdAt;
  });

  if (visible.length === 0) {
    taskList.innerHTML = `<div class="empty-state"><div class="icon">üåø</div><p>Nothing here yet ‚Äî tap <strong>+</strong> to add something!</p></div>`;
    return;
  }

  const pending = visible.filter(t => !t.done);
  const done    = visible.filter(t =>  t.done);
  let html = "";
  if (pending.length) {
    html += `<div class="section-title">Pending <span class="count">${pending.length}</span></div>`;
    html += pending.map(cardHTML).join("");
  }
  if (done.length) {
    html += `<div class="section-title">Completed <span class="count">${done.length}</span></div>`;
    html += done.map(cardHTML).join("");
  }
  taskList.innerHTML = html;
}

function cardHTML(t) {
  const catIcon = { shopping: "üõí", farm: "üåø", todo: "üìù" };
  const dateStr = t.date ? formatDate(t.date) : "";
  let badges = "";
  if (t.person)  badges += `<span class="badge badge-person">üë§ ${t.person}</span>`;
  if (t.category) badges += `<span class="badge badge-cat">${catIcon[t.category] || ""} ${capitalize(t.category)}</span>`;
  
  if (t.location) {
    const locIcons = { home: "üè†", sapling: "üöú", other: "üìç" };
    const locNames = { home: "Home", sapling: "Sapling", other: "Other" };
    badges += `<span class="badge badge-location">${locIcons[t.location] || "üìç"} ${locNames[t.location] || t.location}</span>`;
  }
  
  if (t.store)   badges += `<span class="badge badge-store">üìç ${t.store}</span>`;
  if (t.qty) {
    const displayUnit = t.unit === "custom" ? t.customUnit : t.unit;
    const qtyText = displayUnit ? `${t.qty} ${displayUnit}` : t.qty;
    badges += `<span class="badge badge-cat">üì¶ ${qtyText}</span>`;
  }
  if (t.organic) badges += `<span class="badge badge-organic">üå± Organic</span>`;
  if (t.category === "farm") badges += `<span class="badge badge-farm">üè° Sapling</span>`;
  if (dateStr)   badges += `<span class="badge badge-date">üìÖ ${dateStr}</span>`;

  const noteText = t.farmNote || t.desc || "";

  return `
  <div class="task-card ${t.done ? "done" : ""}" data-cat="${t.category}" data-id="${t.id}" onclick="editTask('${t.id}', event)">
    <div class="task-header">
      <div class="task-left">
        <div class="task-title">${escapeHtml(t.name)}</div>
        ${noteText ? `<div class="task-desc">${escapeHtml(noteText)}</div>` : ""}
        <div class="badges">${badges}</div>
      </div>
      <div class="task-check ${t.done ? "checked" : ""}" onclick="toggleDone('${t.id}', event)"></div>
    </div>
    <button class="task-delete" onclick="deleteTask('${t.id}', event)">‚úï</button>
    <button class="status-btn" onclick="toggleDone('${t.id}', event)">${t.done ? "‚Ü© Reopen" : "‚úì Mark Done"}</button>
  </div>`;
}

function editTask(id, event) {
  if (event) event.stopPropagation();
  if (event && (event.target.classList.contains('task-check') || 
                event.target.classList.contains('task-delete') || 
                event.target.classList.contains('status-btn'))) {
    return;
  }
  const t = tasks.find(x => x.id === id);
  if (t) openModal(t);
}

async function toggleDone(id, event) {
  if (event) event.stopPropagation();
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  try {
    await tasksRef.child(id).update({ done: !t.done });
    showToast(t.done ? "Reopened" : "‚úì Marked as done");
  } catch (err) {
    console.error("Toggle error:", err);
    showToast("‚ö†Ô∏è Update failed");
  }
}

async function deleteTask(id, event) {
  if (event) event.stopPropagation();
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  if (!confirm(`Delete "${t.name}"?\n\nThis cannot be undone.`)) return;
  
  try {
    await tasksRef.child(id).remove();
    showToast("Removed");
  } catch (err) {
    console.error("Delete error:", err);
    showToast("‚ö†Ô∏è Delete failed");
  }
}

document.getElementById("clearBtn").addEventListener("click", async () => {
  if (!confirm("Delete all completed tasks?\n\nThis cannot be undone.")) return;
  
  const completed = tasks.filter(t => t.done);
  try {
    const updates = {};
    completed.forEach(t => { updates[t.id] = null; });
    await tasksRef.update(updates);
    showToast(`‚úì Cleared ${completed.length} tasks`);
  } catch (err) {
    console.error("Clear error:", err);
    showToast("‚ö†Ô∏è Clear failed");
  }
});

document.getElementById("archiveBtn").addEventListener("click", async () => {
  const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
  const toArchive = tasks.filter(t => t.done && t.createdAt < cutoff);
  
  if (toArchive.length === 0) {
    showToast("No old tasks to archive");
    return;
  }
  
  try {
    const archiveRef = db.ref('archive');
    const updates = {};
    toArchive.forEach(t => { 
      updates[`archive/${t.id}`] = t;
      updates[`tasks/${t.id}`] = null;
    });
    await db.ref().update(updates);
    showToast(`‚úì Archived ${toArchive.length} tasks`);
  } catch (err) {
    console.error("Archive error:", err);
    showToast("‚ö†Ô∏è Archive failed");
  }
});

function showToast(msg) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 1800);
}

function formatDate(iso) {
  const d = new Date(iso + "T00:00:00");
  const opts = { month: "short", day: "numeric" };
  return d.toLocaleDateString("en-US", opts);
}
function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
function escapeHtml(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }
</script>
</body>
</html>
